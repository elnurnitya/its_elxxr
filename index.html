<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Merry Christmas and Happy New Year</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&family=Pacifico&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0b0b0b;
      --card: #111;
      --red: #d62828;
      --white: #fff;
      --muted: #b8c2cf;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: url("Image/istockphoto-509422646-612x612.jpg")
                  no-repeat center center fixed;
      background-size: cover;
      color: var(--white);
      font-family: Montserrat, system-ui, Arial, sans-serif;
      padding: 18px;
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
    }

    .center {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* popup name & greeting modal overlay */
    #nameModal,
    #greetingCard {
      position: fixed;
      inset: 0;
      background: linear-gradient(rgba(2, 2, 2, 0.5), rgba(2, 2, 2, 0.5));
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-card {
      background: rgba(11, 19, 32, 0.40);
      padding: 26px;
      border-radius: 5px;
      width: 94%;
      max-width: 420px;
      text-align: center;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.7);
    }

    .modal-card h2 {
      font-family: "Georgia", serif;
      color: var(--white);
      margin: 0 0 8px;
    }

    .modal-card input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: transparent;
      color: inherit;
    }

    .btn {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      background: var(--red);
      color: #fff;
      cursor: pointer;
      margin-top: 12px;
    }

    /* global card style */
    .card {
      position: relative;
      padding: 22px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.03);
      box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
      margin: 18px 0;
      background: url("Image/fourth of july fireworks GIF by hateplow.gif")
                  center/cover no-repeat;
      overflow: hidden;
      z-index: 10;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(11, 19, 32, 0.45);
      backdrop-filter: blur(1px);
      z-index: 0;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .card.small {
      width: 80vw;
      max-width: 900px;
      margin: 12px auto;
      padding: 32px;
      border-radius: 18px;
    }

    .card-title {
      font-family: "Pacifico", "Georgia", serif;
      font-size: 46px;
      margin: 0 0 10px;
      text-align: center;
      line-height: 1.15;
    }

    /* tema Natal merah–putih + glow untuk title */
    #greetingCard .card-title span {
      text-shadow:
        0 0 4px rgba(255, 255, 255, 0.9),
        0 0 10px rgba(255, 255, 255, 0.8),
        0 0 18px rgba(255, 75, 92, 0.6),
        0 0 32px rgba(255, 75, 92, 0.4);
      animation: titleGlow 2.6s ease-in-out infinite;
    }

    #greetingCard .title-red {
      color: #ff4b5c;
    }

    #greetingCard .title-white {
      color: #ffffff;
    }

    #greetingCard .title-amp {
      color: #f5db76;
      margin: 0 6px;
    }

    @keyframes titleGlow {
      0%, 100% {
        text-shadow:
          0 0 2px rgba(255, 255, 255, 0.5),
          0 0 6px rgba(255, 255, 255, 0.4),
          0 0 12px rgba(255, 75, 92, 0.3),
          0 0 20px rgba(255, 75, 92, 0.2);
      }
      50% {
        text-shadow:
          0 0 4px rgba(255, 255, 255, 1),
          0 0 12px rgba(255, 255, 255, 0.9),
          0 0 24px rgba(255, 75, 92, 0.8),
          0 0 40px rgba(255, 75, 92, 0.6);
      }
    }

    p.lead {
      margin: 0;
      color: var(--muted);
    }

    #greetingCard .lead {
      margin-top: 18px;
    }

    .greeting-inner {
      text-align: center;
    }

    /* Nama spesial */
    #greetName {
      font-family: "Georgia", serif;
      font-size: 42px;
      font-weight: 700;
      color: #ffffff;
      margin: 24px 0 28px;
      letter-spacing: 1px;
      text-shadow:
        0 0 4px rgba(255, 255, 255, 0.45),
        0 0 10px rgba(255, 255, 255, 0.45),
        0 0 20px rgba(255, 255, 255, 0.35);
      animation: nameGlow 3s ease-in-out infinite;
    }

    @keyframes nameGlow {
      0%, 100% {
        text-shadow:
          0 0 3px rgba(255, 255, 255, 0.35),
          0 0 8px rgba(255, 255, 255, 0.25),
          0 0 14px rgba(255, 255, 255, 0.2);
      }
      50% {
        text-shadow:
          0 0 6px rgba(255, 255, 255, 0.7),
          0 0 14px rgba(255, 255, 255, 0.6),
          0 0 26px rgba(255, 255, 255, 0.5);
      }
    }

    @media (max-width:640px){
      #greetName{
        font-size: 32px;
      }
    }

    .card-gifs {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin: 6px 0 10px;
    }

    #greetingCard .card-gifs .gif {
      width: 60%;
      height: auto;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }

    .card-gifs .santa {
      animation: santaFloat 2.6s ease-in-out infinite;
    }

    @keyframes santaFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    #greetingCard {
      display: none;
      cursor: pointer;
    }

    .letter-icon {
      width: 15%;
      max-width: 260px;
      height: auto;
      display: block;
      margin: 16px auto 0;
    }

    .card .lead {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    @media (max-width:640px){
      .card .lead svg{
        width: 28%;
      }
    }

    /* MESSAGE CARD */
    #messageCard {
      display: none;
    }

    #messageCard #messageText {
      width: 80%;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.55);
      padding: 16px 20px;
      border-radius: 14px;
      line-height: 1.55;
    }

    #messageCard .lead {
      display: block;
      text-align: left;
    }

    /* tree area */
    #treeCard {
      display: none;
      text-align: center;
    }

    #tree-wrap {
      display: inline-block;
      padding: 16px;
      background: linear-gradient(180deg, #071116, #0b1620);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.03);
    }

    .tree-svg {
      width: 320px;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    /* wish list */
    #wishList {
      max-width: 460px;
      margin: 12px auto;
      text-align: left;
    }

    .wish-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border-left: 4px solid var(--red);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .wish-delete {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
    }

    .wish-delete:hover {
      background: var(--red);
    }

    .wish-note {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      max-width: 260px;
      margin-left: auto;
      margin-right: auto;
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 12px;
    }

    .controls.lang-toggle {
      justify-content: flex-end;
    }

    .download-btn {
      background: var(--red);
      border: none;
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
    }

    /* snow (canvas) overlay */
    #snow-canvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
    }

    .glow {
      box-shadow: 0 8px 40px rgba(214, 40, 40, 0.12);
    }

    @media (max-width: 640px) {
      .card-title {
        font-size: 32px;
      }
      #greetingCard .card-gifs .gif {
        width: 70%;
      }
      #greetName {
        font-size: 32px;
      }
      .tree-svg {
        width: 240px;
      }
    }
  </style>
</head>
<body>

<div class="wrap">
  <!-- NAME POPUP -->
  <div id="nameModal">
    <div class="modal-card">
      <h2>Enter Your Name</h2>
      <input id="username" placeholder="Your name (e.g. Elnur Nitya)" />
      <button class="btn" id="btnStart">Start</button>
    </div>
  </div>

  <!-- GREETING CARD -->
  <div id="greetingCard" class="card small">
    <div class="greeting-inner">
      <div class="card-title">
        <span class="title-red">Merry Christmas</span>
        <span class="title-amp">&</span>
        <span class="title-white">Happy New Year</span>
      </div>

      <h1 id="greetName"></h1>

      <div class="card-gifs">
        <img src="Image/Santa Clause GIF by filmeditor.gif"
             alt="Santa Claus"
             class="gif santa">
      </div>

      <p class="lead">
        Click this card to open your special message.
      </p>

      <svg class="letter-icon"
           viewBox="0 0 24 24"
           fill="none"
           stroke="white"
           stroke-width="2"
           stroke-linecap="round"
           stroke-linejoin="round">
        <rect x="3" y="5" width="18" height="14" rx="2" ry="2"></rect>
        <polyline points="3 7 12 13 21 7"></polyline>
      </svg>
    </div>
  </div>

  <!-- MESSAGE CARD -->
  <div id="messageCard" class="card">
    <div class="inner">
      <div class="controls lang-toggle" style="margin-bottom: 10px;">
        <button class="btn btn-lang" data-lang="id">Indonesia</button>
        <button class="btn btn-lang" data-lang="en">English</button>
      </div>

      <div class="card-title" id="messageTitle">Pesan Hangat</div>
      <p class="lead" id="messageText"></p>

      <div class="controls">
        <button class="btn" id="btnOpenTree">Buka Wish Tree</button>
      </div>
    </div>
  </div>

  <!-- WISH TREE CARD (CARD TERAKHIR) -->
  <div id="treeCard" class="card center">
    <div id="tree-wrap">
      <svg class="tree-svg" viewBox="0 0 200 330" xmlns="http://www.w3.org/2000/svg" id="svgTree">

        <!-- batang -->
        <rect x="90" y="250" width="20" height="60" rx="2" fill="#5b3a2e"></rect>

        <!-- Layer 5 (paling bawah - paling lebar) -->
        <polygon points="100,160 20,250 180,250" fill="#084523"></polygon>

        <!-- Layer 4 -->
        <polygon points="100,130 27.5,220 172.5,220" fill="#0a5c2f"></polygon>

        <!-- Layer 3 -->
        <polygon points="100,100 35,190 165,190" fill="#0d733b"></polygon>

        <!-- Layer 2 -->
        <polygon points="100,70 42.5,160 157.5,160" fill="#0f8a46"></polygon>

        <!-- Layer 1 (paling atas - paling kecil) -->
        <polygon points="100,40 50,130 150,130" fill="#12a152"></polygon>

        <g id="wishTextGroup"></g>

        <!-- bintang -->
        <polygon points="100,18 105,30 118,30 108,38 112,50 
                         100,42 88,50 92,38 82,30 95,30"
            fill="#ffd166"></polygon>
      </svg>

      <div style="margin-top:12px">
        <input id="wishInput"
               placeholder="Tulis satu kata untuk wish-mu (maks. 10 wish)"
               style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);width:260px;background:transparent;color:inherit">
        <button class="btn" id="addWish">Tambah</button>
      </div>

      <p id="wishNote" class="wish-note">
        Catatan: Tulis 1 kata saja per wish (misalnya: Kesehatan, Keluarga, Damai). Maksimal 10 wish. Tekan Enter atau klik Tambah. Klik "Hapus" untuk menghapus wish.
      </p>

      <div id="wishList"></div>

      <div class="controls" style="margin-top:12px">
        <button class="download-btn" id="downloadCardBtn">Download Card (PNG)</button>
        <button class="download-btn" id="downloadTreeBtn">Download Tree (PNG)</button>
      </div>
    </div>
  </div>
</div>

<canvas id="snow-canvas"></canvas>

<script>
  const nameModal   = document.getElementById('nameModal');
  const btnStart    = document.getElementById('btnStart');
  const greetCard   = document.getElementById('greetingCard');
  const messageCard = document.getElementById('messageCard');
  const treeCard    = document.getElementById('treeCard');
  const greetName   = document.getElementById('greetName');
  const btnOpenTree = document.getElementById('btnOpenTree');

  // multi-bahasa untuk message card
  const messageTitle = document.getElementById('messageTitle');
  const messageText  = document.getElementById('messageText');
  const langButtons  = document.querySelectorAll('.btn-lang');

  let currentLang = 'en';

  const cardMessages = {
    id: `Di Natal ini, aku berdoa agar rumahmu menjadi tempat di mana terang Kristus bersinar lebih terang, kasih tumbuh lebih dalam, dan sukacita dibagikan dengan tulus.<br><br>
    Kiranya kisah kelahiran-Nya mengingatkanmu bahwa apa pun yang terjadi selama tahun ini, Tuhan tetap bekerja, tetap mengasihi, dan tetap menuliskan sesuatu yang indah dalam hidupmu.<br><br>
    
    Saat Tahun Baru mendekat, kiranya Tuhan melingkupimu dengan perlindungan-Nya, memberkati rencanamu, menyembuhkan setiap luka, dan menuntun langkahmu menuju kesempatan-kesempatan yang penuh tujuan.<br><br>
    Kiranya hadirat-Nya menjadi penghiburanmu dan janji-Nya menjadi kekuatanmu.<br><br>
    
    <strong>Selamat Natal dan Tahun Baru.</strong><br><br>
    <strong>Kiranya kasih Kristus menjadi dasar dari segala sesuatu yang akan datang.</strong>`,
      
    en: `This Christmas, I pray that your home becomes a place where Christ’s light shines brighter, where love grows deeper, and where joy is shared generously.<br><br>
    May the story of His birth remind you that no matter how the year has been, God is still working, still loving, and still writing something beautiful for your life.<br><br>
    
    As the New Year approaches, may God surround you with His protection, bless your plans, heal every wound, and guide your steps into opportunities filled with purpose.<br><br>
    May His presence be your comfort and His promises be your strength.<br><br>
  
    <strong>Merry Christmas and Happy New Year.</strong><br><br>
    <strong>May Christ’s love be the foundation of everything ahead.</strong>`
  };

  function setMessageLanguage(lang) {
    currentLang = lang;
    messageText.innerHTML = cardMessages[lang];

    messageTitle.textContent = (lang === 'id')
      ? 'Pesan Hangat'
      : 'Warm Message';

    btnOpenTree.textContent = (lang === 'id')
      ? 'Buka Wish Tree'
      : 'Open Wish Tree';

    langButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.lang === lang);
    });

    syncTreeLanguage();
  }

  langButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const lang = btn.dataset.lang;
      setMessageLanguage(lang);
    });
  });

  // default: English
  setMessageLanguage('en');

  // snow
  const canvas = document.getElementById('snow-canvas');
  const ctx = canvas.getContext('2d');

  function resize() {
    canvas.width = innerWidth;
    canvas.height = innerHeight;
  }
  addEventListener('resize', resize);
  resize();

  let flakes = [];
  function initSnow(n = 160) {
    flakes = [];
    for (let i = 0; i < n; i++) {
      flakes.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: Math.random() * 3 + 1,
        d: Math.random() * 1.5 + 0.5,
        spd: Math.random() * 0.8 + 0.2
      });
    }
  }

  function renderSnow() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    flakes.forEach(f => {
      ctx.beginPath();
      ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
      ctx.fill();
      f.y += f.spd + f.d;
      f.x += Math.sin(f.y / 30) * 0.6;
      if (f.y > canvas.height) {
        f.y = -10;
        f.x = Math.random() * canvas.width;
      }
    });
    requestAnimationFrame(renderSnow);
  }

  initSnow(160);
  renderSnow();

  // flow: name -> greeting -> message -> tree
  btnStart.onclick = () => {
    const name = document.getElementById('username').value.trim();
    if (!name) return alert('Isi nama dulu ya');
    nameModal.style.display = 'none';
    greetName.innerText = name;
    greetCard.style.display = 'flex';
  };

  greetCard.onclick = () => {
    greetCard.style.display = 'none';
    messageCard.style.display = 'block';
    messageCard.classList.add('glow');
    setTimeout(() => messageCard.classList.remove('glow'), 900);
  };

  btnOpenTree.onclick = () => {
    messageCard.style.display = 'none';
    treeCard.style.display = 'block';
    syncTreeLanguage();
  };

  // WISH TREE
  const svgTree     = document.getElementById('svgTree');
  const wishGroup   = document.getElementById('wishTextGroup');
  const wishInput   = document.getElementById('wishInput');
  const addWishBtn  = document.getElementById('addWish');
  const wishListEl  = document.getElementById('wishList');
  const wishNote    = document.getElementById('wishNote');
  const downloadCardBtn = document.getElementById('downloadCardBtn');
  const downloadTreeBtn = document.getElementById('downloadTreeBtn');

  let wishes = [];

  function syncTreeLanguage() {
    if (!wishInput) return;

    if (currentLang === 'id') {
      wishInput.placeholder = 'Tulis satu kata untuk wish-mu (maks. 10 wish)';
      addWishBtn.textContent = 'Tambah';
      wishNote.textContent =
        'Catatan: Tulis 1 kata saja per wish (misalnya: Kesehatan, Keluarga, Damai). Maksimal 10 wish. Klik Tambah. Klik "Hapus" untuk menghapus wish.';
      downloadCardBtn.textContent = 'Unduh Kartu (PNG)';
      downloadTreeBtn.textContent = 'Unduh Pohon (PNG)';
    } else {
      wishInput.placeholder = 'Type one word for your wish (max 10 wishes)';
      addWishBtn.textContent = 'Add';
      wishNote.textContent =
        'Note: Type 1 word only for each wish (for example: Health, Family, Peace). Maximum 10 wishes. Click Add. Click "Delete" to remove a wish.';
      downloadCardBtn.textContent = 'Download Card (PNG)';
      downloadTreeBtn.textContent = 'Download Tree (PNG)';
    }

    renderWishes();
  }

  function computePositionForIndex(idx) {
    const centerX = 100;

    // wish pertama di paling atas tengah
    if (idx === 0) {
      return { x: centerX, y: 60, row: 0 };
    }

    // setelah itu: setiap baris isi max 2 wish
    const pairIndex = idx - 1;
    const row = Math.floor(pairIndex / 2) + 1;
    const posInRow = pairIndex % 2;

    const yStart = 95;
    const rowSpacing = 35;
    const y = yStart + (row - 1) * rowSpacing;

    const xOffset = 30;
    const x = posInRow === 0 ? centerX - xOffset : centerX + xOffset;

    return { x, y, row };
  }

  function wrapText(text, maxChars = 20) {
    const words = text.split(' ');
    const lines = [];
    let cur = '';
    for (const w of words) {
      const test = (cur + ' ' + w).trim();
      if (test.length <= maxChars) {
        cur = test;
      } else {
        if (cur) lines.push(cur);
        cur = w;
      }
    }
    if (cur) lines.push(cur);
    return lines;
  }

  function placeWishText(text, idx) {
    const pos = computePositionForIndex(idx);
    const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    txt.setAttribute('x', pos.x);
    txt.setAttribute('y', pos.y);
    txt.setAttribute('fill', '#ffffff');
    txt.setAttribute('font-size', '10');
    txt.setAttribute('font-weight', '600');
    txt.setAttribute('text-anchor', 'middle');

    const lines = wrapText(text, 16);
    const startDy = -(lines.length - 1) * 7;
    lines.forEach((ln, i) => {
      const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
      tspan.setAttribute('x', pos.x);
      tspan.setAttribute('dy', i === 0 ? startDy : 14);
      tspan.textContent = ln;
      txt.appendChild(tspan);
    });

    txt.addEventListener('click', () => {
      const msg = (currentLang === 'id' ? 'Wish-mu: ' : 'Your wish: ');
      alert(msg + text);
    });

    wishGroup.appendChild(txt);
  }

  function renderWishes() {
    wishGroup.innerHTML = '';
    wishListEl.innerHTML = '';

    wishes.forEach((w, i) => {
      placeWishText(w, i);

      const d = document.createElement('div');
      d.className = 'wish-item';

      const span = document.createElement('span');
      span.innerHTML = `<strong>${i + 1}.</strong> ${w}`;

      const delBtn = document.createElement('button');
      delBtn.className = 'wish-delete';
      delBtn.textContent = (currentLang === 'id') ? 'Hapus' : 'Delete';
      delBtn.addEventListener('click', () => {
        wishes.splice(i, 1);
        renderWishes();
      });

      d.appendChild(span);
      d.appendChild(delBtn);
      wishListEl.appendChild(d);
    });
  }

  addWishBtn.onclick = () => {
    const raw = wishInput.value.trim();

    if (!raw) {
      return alert(
        currentLang === 'id'
          ? 'Tulis harapan dulu, ya.'
          : 'Please write a wish first.'
      );
    }

    if (wishes.length >= 10) {
      return alert(
        currentLang === 'id'
          ? 'Maksimal 10 wish saja ya untuk pohon ini.'
          : 'Maximum 10 wishes for this tree.'
      );
    }

    const parts = raw.split(/\s+/).filter(Boolean);
    if (parts.length > 1) {
      return alert(
        currentLang === 'id'
          ? 'Untuk wish tree, tulis 1 kata saja. Misalnya: Kesehatan, Keluarga, Damai.'
          : 'For the wish tree, please type only one word. For example: Health, Family, Peace.'
      );
    }

    const v = parts[0];
    if (!v) return;

    wishes.push(v);
    renderWishes();
    wishInput.value = '';
  };

  wishInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addWishBtn.click();
    }
  });

  // SVG -> PNG helper
  function svgToDataUrl(svgEl, scale = 2) {
    return new Promise((resolve, reject) => {
      const clone = svgEl.cloneNode(true);
      const serializer = new XMLSerializer();
      let svgString = serializer.serializeToString(clone);
      if (!svgString.match(/^<svg[^>]+xmlns=/)) {
        svgString = svgString.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg" ');
      }
      svgString = '<?xml version="1.0" standalone="no"?>\n' + svgString;
      const svg64 = encodeURIComponent(svgString);
      const url = 'data:image/svg+xml;charset=utf-8,' + svg64;
      const img = new Image();
      img.onload = () => {
        const viewBox = svgEl.viewBox.baseVal;
        const w = viewBox && viewBox.width ? viewBox.width : svgEl.clientWidth;
        const h = viewBox && viewBox.height ? viewBox.height : svgEl.clientHeight;
        const canvas = document.createElement('canvas');
        canvas.width = (w || svgEl.clientWidth) * scale;
        canvas.height = (h || svgEl.clientHeight) * scale;
        const cctx = canvas.getContext('2d');
        cctx.fillStyle = 'transparent';
        cctx.fillRect(0, 0, canvas.width, canvas.height);
        cctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const data = canvas.toDataURL('image/png');
        resolve({ data, width: canvas.width, height: canvas.height });
      };
      img.onerror = (e) => reject(e);
      img.crossOrigin = 'anonymous';
      img.src = url;
    });
  }

  const cardDownloadTexts = {
    id: {
      title: 'Selamat Natal & Tahun Baru',
      message: 'Semoga tahun yang baru menghadirkan sukacita, kesehatan yang terjaga, dan kenangan indah untuk kamu simpan.',
      footer: 'Peluk Hangat & Cinta\nElnur Nitya'
    },
    en: {
      title: 'Merry Christmas & Happy New Year',
      message: 'May the coming year bring you joy, good health an beautiful memories to cherish.',
      footer: 'With Big Hug & Love\nElnur Nitya'
    }
  };

  // DOWNLOAD Tree – tetap di treeCard (tidak pindah ke card lain)
  downloadTreeBtn.addEventListener('click', async () => {
    try {
      const svg = document.getElementById('svgTree');
      const out = await svgToDataUrl(svg, 2);
      const a = document.createElement('a');
      a.href = out.data;
      a.download = `wish-tree-${Date.now()}.png`;
      a.click();
    } catch (err) {
      alert('Gagal generate tree: ' + err);
      console.error(err);
    }
  });

  // DOWNLOAD Card 9:16
  document.getElementById('downloadCardBtn').addEventListener('click', async () => {
    try {
      const svg = document.getElementById('svgTree');
      const svgOut = await svgToDataUrl(svg, 2);

      // background card
      const bgImg = await new Promise((resolve, reject) => {
        const img = new Image();
        img.src = 'Image/bacground_card.jpg';
        img.onload = () => resolve(img);
        img.onerror = reject;
      });

      const W = 1080;
      const H = 1920;
      const c = document.createElement('canvas');
      const cctx = c.getContext('2d');
      c.width = W;
      c.height = H;

      // background
      cctx.drawImage(bgImg, 0, 0, W, H);

      // overlay gelap
      cctx.fillStyle = 'rgba(0,0,0,0.45)';
      cctx.fillRect(0, 0, W, H);

      const name = greetName.innerText || '';
      const dict = cardDownloadTexts[currentLang] || cardDownloadTexts.id;

      function wrapTextCenter(text, font, x, y, maxWidth, lineHeight) {
        cctx.font = font;
        cctx.textAlign = "center";

        const words = text.split(" ");
        let line = "";
        let testLine = "";
        let lines = [];

        for (let i = 0; i < words.length; i++) {
          testLine = line + words[i] + " ";
          if (cctx.measureText(testLine).width > maxWidth && i > 0) {
            lines.push(line);
            line = words[i] + " ";
          } else {
            line = testLine;
          }
        }
        lines.push(line);

        lines.forEach((ln, i) => {
          cctx.fillText(ln.trim(), x, y + i * lineHeight);
        });

        return y + lines.length * lineHeight;
      }

      // TITLE merah
      cctx.fillStyle = "#ff4b5c";
      cctx.shadowColor = 'rgba(255,255,255,0.85)';
      cctx.shadowBlur = 18;

      let nextY = wrapTextCenter(
        dict.title,
        'bold 72px "Georgia", serif',
        W / 2,
        170,
        W - 200,
        80
      );

      cctx.shadowBlur = 0;

      // Nama
      if (name) {
        cctx.font = 'bold 60px "Georgia", serif';
        cctx.fillStyle = '#ffffff';
        cctx.shadowColor = 'rgba(246,190,22,0.85)';
        cctx.shadowBlur = 18;

        cctx.textAlign = 'center';
        cctx.fillText(name, W / 2, nextY + 70);

        cctx.shadowBlur = 0;
        nextY += 120;
      }

      // Pesan putih
      cctx.fillStyle = "#ffffff";
      nextY = wrapTextCenter(
        dict.message,
        '40px "Georgia", serif',
        W / 2,
        nextY + 60,
        W - 240,
        50
      );

      // Pohon
      const treeImg = new Image();
      treeImg.src = svgOut.data;
      await new Promise((res, rej) => {
        treeImg.onload = res;
        treeImg.onerror = rej;
      });

      const tw = 620;
      const th = (treeImg.height / treeImg.width) * tw;

      cctx.drawImage(treeImg, (W - tw) / 2, nextY + 80, tw, th);

      // Footer
      if (dict.footer) {
        cctx.font = '34px "Georgia", serif';
        cctx.fillStyle = '#f5db76';
        cctx.textAlign = 'center';
        cctx.shadowColor = 'rgba(0,0,0,0.85)';
        cctx.shadowBlur = 18;

        const footerLines = dict.footer.split('\n');
        let fy = H - 150;

        footerLines.forEach(line => {
          cctx.fillText(line, W / 2, fy);
          fy += 46;
        });
      }

      const a = document.createElement("a");
      a.href = c.toDataURL("image/png");
      a.download = `card-${Date.now()}.png`;
      a.click();

    } catch (err) {
      alert("Gagal generate card: " + err);
      console.error(err);
    }
  });

  // initial hide
  messageCard.style.display = 'none';
  treeCard.style.display = 'none';
</script>
</body>
</html>
