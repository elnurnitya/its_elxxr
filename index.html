<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kartu Natal & Tahun Baru — Interactive Template</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&family=Pacifico&display=swap" rel="stylesheet">

  <style>
    :root{--bg:#0b0b0b;--card:#111;--red:#d62828;--white:#fff;--muted:#b8c2cf}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#070707,#0b1320);color:var(--white);font-family:Montserrat,system-ui,Arial;padding:18px}

    /* layout */
    .wrap{max-width:980px;margin:0 auto}
    .center{display:flex;align-items:center;justify-content:center}

    /* popup name */
    #nameModal{position:fixed;inset:0;background:linear-gradient(rgba(3,3,3,0.85),rgba(3,3,3,0.85));z-index:9999;display:flex;align-items:center;justify-content:center}
    .modal-card{background:linear-gradient(180deg,#121212,#0f0f12);padding:26px;border-radius:16px;border:2px solid rgba(214,40,40,0.12);width:94%;max-width:420px;text-align:center;box-shadow:0 8px 40px rgba(0,0,0,0.7)}
    .modal-card h2{font-family:Pacifico;color:var(--red);margin:0 0 8px}
    .modal-card input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:none;background:var(--red);color:#fff;cursor:pointer;margin-top:12px}

    /* global card style */
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(2,6,23,0.6);margin:18px 0}
    .card.small{max-width:420px;margin:12px auto}
    .card-title{font-family:Pacifico;color:var(--red);font-size:22px;margin:0 0 6px}
    p.lead{margin:0;color:var(--muted)}

    /* greeting card */
    #greetingCard{display:none;cursor:pointer}
    #greetingCard .inner{padding:18px;border-radius:12px;background:linear-gradient(180deg,#120a0a,#0c0c0c);border:1px solid rgba(214,40,40,0.12)}
    #greetingCard h1{font-family:Pacifico;color:var(--red);margin:0 0 6px}
    #greetingCard .name{font-weight:700;font-size:18px;color:var(--white)}

    /* message */
    #messageCard{display:none}

    /* tree area */
    #treeCard{display:none;text-align:center}
    #tree-wrap{display:inline-block;padding:16px;background:linear-gradient(180deg,#071116,#0b1620);border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    /* SVG tree styles */
    .tree-svg{width:320px;height:auto;display:block;margin:0 auto}

    /* twinkling lights */
    .light{filter:drop-shadow(0 0 8px rgba(214,40,40,0.6))}
    @keyframes twinkle{0%{opacity:0.2;transform:scale(0.9)}50%{opacity:1;transform:scale(1.08)}100%{opacity:0.25;transform:scale(0.95)}}
    .light--a{animation:twinkle 1.6s infinite ease-in-out}
    .light--b{animation:twinkle 1.9s infinite ease-in-out}
    .light--c{animation:twinkle 2.2s infinite ease-in-out}

    /* wish list */
    #wishList{max-width:460px;margin:12px auto;text-align:left}
    .wish-item{background:rgba(255,255,255,0.03);padding:10px;margin:8px 0;border-radius:8px;border-left:4px solid var(--red)}

    /* controls */
    .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:12px}

    /* download buttons */
    .download-btn{background:var(--red);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}

    /* recap */
    #recap{display:none}
    .recap-slider{display:flex;gap:12px;overflow:hidden}
    .recap-slide{min-width:100%;transition:transform .4s}

    /* responsive */
    @media (max-width:640px){.tree-svg{width:240px}}

    /* snow (canvas) overlay */
    #snow-canvas{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
    }
    
    .card {
      position: relative;
      z-index: 10; /* card selalu di atas salju */
    }

    /* subtle glow around cards */
    .glow{box-shadow:0 8px 40px rgba(214,40,40,0.12)}

  </style>
</head>
<body>

<div class="wrap">
  <!-- NAME POPUP -->
  <div id="nameModal">
    <div class="modal-card">
      <h2>Masukkan Nama Kamu</h2>
      <input id="username" placeholder="Nama kamu (mis. Budi)" />
      <div style="margin-top:10px;color:var(--muted)">Nama akan tampil di kartu ucapanmu.</div>
      <button class="btn" id="btnStart">Mulai</button>
    </div>
  </div>

  <!-- GREETING CARD -->
  <div id="greetingCard" class="card small center">
    <div class="inner">
      <div class="card-title">Selamat Natal & Tahun Baru</div>
      <h1 id="greetName" style="margin:6px 0 0;font-size:20px"></h1>
      <p class="lead" style="margin-top:8px">Klik kartu ini untuk membuka pesan spesial untukmu.</p>
    </div>
  </div>

  <!-- MESSAGE CARD -->
  <div id="messageCard" class="card">
    <div class="inner">
      <div class="card-title">Pesan Hangat</div>
      <p class="lead">Semoga tahun mendatang membawa kebahagiaan, kesehatan, dan kenangan manis. Klik tombol untuk menaruh harapanmu di pohon Natal.</p>
      <div class="controls">
        <button class="btn" id="btnOpenTree">Buka Wish Tree</button>
        <button class="btn" id="btnPlayMusic">Pause Music</button>
      </div>
    </div>
  </div>

  <!-- WISH TREE CARD -->
  <div id="treeCard" class="card center">
    <div id="tree-wrap">
      <!-- SVG tree with lights & text-wishes -->
      <svg class="tree-svg" viewBox="0 0 200 300" xmlns="http://www.w3.org/2000/svg" id="svgTree">
        <!-- trunk -->
        <rect x="90" y="250" width="20" height="40" rx="2" fill="#5b3a2e"></rect>

        <!-- three-layer tree (triangles) -->
        <polygon id="layer1" points="100,140 70,220 130,220" fill="#0b6b37"></polygon>
        <polygon id="layer2" points="100,80 55,160 145,160" fill="#094f29"></polygon>
        <polygon id="layer3" points="100,20 40,110 160,110" fill="#063b1f"></polygon>

        <!-- text-wishes group -->
        <g id="wishTextGroup"></g>

        <!-- star -->
        <polygon points="100,8 105,20 118,20 108,28 112,40 100,32 88,40 92,28 82,20 95,20" fill="#ffd166"></polygon>
      </svg>

      <div style="margin-top:12px">
        <input id="wishInput" placeholder="Tulis wish... (bisa banyak)" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);width:260px;background:transparent;color:inherit">
        <button class="btn" id="addWish">Tambah</button>
      </div>

      <div id="wishList"></div>

      <div class="controls" style="margin-top:12px">
        <button class="download-btn" id="downloadCardBtn">Download Card (PNG)</button>
        <button class="download-btn" id="downloadTreeBtn">Download Tree (PNG)</button>
      </div>
    </div>
  </div>

  <!-- RECAP -->
  <div id="recap" class="card">
    <div class="card-title">Recap Tahun Ini</div>
    <div class="recap-slider" id="recapSlider" style="overflow:hidden;position:relative">
      <div class="recap-slide" id="recapInner" style="display:flex;transition:transform .45s">
        <!-- slides injected -->
      </div>
    </div>
    <div class="controls" style="margin-top:12px">
      <button class="btn" id="prevSlide">Prev</button>
      <button class="btn" id="nextSlide">Next</button>
    </div>
  </div>

</div>

<!-- canvas for snow -->
<canvas id="snow-canvas"></canvas>

<script>
  // ---------- small helper ----------
  const nameModal = document.getElementById('nameModal');
  const btnStart = document.getElementById('btnStart');
  const greetCard = document.getElementById('greetingCard');
  const messageCard = document.getElementById('messageCard');
  const treeCard = document.getElementById('treeCard');
  const recapCard = document.getElementById('recap');
  const greetName = document.getElementById('greetName');
  const btnOpenTree = document.getElementById('btnOpenTree');
  const btnPlayMusic = document.getElementById('btnPlayMusic');

  // music (replace src with your file path)
  const music = new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_9b8a1b6e4f.mp3?filename=relaxing-guitar-111409.mp3');
  music.loop = true; music.volume = 0.6; music.play().catch(()=>{});
  let musicPlaying = true;
  btnPlayMusic.addEventListener('click', ()=>{
    if(musicPlaying){ music.pause(); btnPlayMusic.innerText = 'Play Music'; }
    else { music.play(); btnPlayMusic.innerText = 'Pause Music'; }
    musicPlaying = !musicPlaying;
  });

  // snow canvas
  const canvas = document.getElementById('snow-canvas'); const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  addEventListener('resize', resize); resize();
  let flakes = [];
  function initSnow(n=160){ flakes = []; for(let i=0;i<n;i++){ flakes.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*3+1,d:Math.random()*1.5+0.5,spd:Math.random()*0.8+0.2}) }}
  function renderSnow(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle='rgba(255,255,255,0.9)'; flakes.forEach(f=>{ ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill(); f.y += f.spd + f.d; f.x += Math.sin(f.y/30)*0.6; if(f.y>canvas.height){ f.y = -10; f.x = Math.random()*canvas.width } }); requestAnimationFrame(renderSnow); }
  initSnow(160); renderSnow();

  // flow: name -> greeting -> message -> tree -> recap
  btnStart.onclick = ()=>{
    const name = document.getElementById('username').value.trim();
    if(!name) return alert('Isi nama dulu ya');
    nameModal.style.display='none';
    greetName.innerText = name;
    greetCard.style.display='block';
  }
  greetCard.onclick = ()=>{ greetCard.style.display='none'; messageCard.style.display='block'; messageCard.classList.add('glow'); setTimeout(()=>messageCard.classList.remove('glow'),900)}
  btnOpenTree.onclick = ()=>{ messageCard.style.display='none'; treeCard.style.display='block'; }

  // ————— WISH TEXT PLACEMENT (grid within tree) —————
  const svgTree = document.getElementById('svgTree');
  const wishGroup = document.getElementById('wishTextGroup');
  const wishInput = document.getElementById('wishInput');
  const addWishBtn = document.getElementById('addWish');
  const wishListEl = document.getElementById('wishList');
  let wishes = [];

  // compute position for a wish by index using triangular levels (level 0..4)
  function computePositionForIndex(idx){
    // levels: 1,2,3,4,5 items => cumulative 1,3,6,10,15
    let level = 0, cumulative = 0;
    while(true){
      cumulative += (level+1);
      if(idx < cumulative) break;
      level++;
    }
    const levelStart = cumulative - (level+1); // index of first in this level
    const posInLevel = idx - levelStart; // 0..level
    // map into svg coords (viewBox 0..200 x 0..300)
    // y: start 60, gap 35
    const maxWidth = 120 - (level * 12); // narrower for lower levels
    const xCenter = 100;
    const slots = level+1;
    const spacing = maxWidth / slots;
    const x = xCenter + (posInLevel - (slots-1)/2) * spacing;
    const y = 60 + level * 40;
    return {x: Math.round(x), y: Math.round(y), level};
  }

  // wrap text into lines (maxChars per line) — returns array of lines
  function wrapText(text, maxChars=20){
    const words = text.split(' ');
    const lines = [];
    let cur = '';
    for(const w of words){
      if((cur + ' ' + w).trim().length <= maxChars){
        cur = (cur + ' ' + w).trim();
      } else {
        if(cur) lines.push(cur);
        cur = w;
      }
    }
    if(cur) lines.push(cur);
    return lines;
  }

  function placeWishText(text, idx){
    const pos = computePositionForIndex(idx);
    // create text element with tspans for lines
    const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
    txt.setAttribute('x', pos.x);
    txt.setAttribute('y', pos.y);
    txt.setAttribute('fill', '#ffffff');
    txt.setAttribute('font-size', '10');
    txt.setAttribute('font-weight', '600');
    txt.setAttribute('text-anchor', 'middle');
    txt.setAttribute('pointer-events','visible'); // clickable
    // wrap
    const lines = wrapText(text, 16);
    const startDy = -(lines.length-1)*7; // center the block vertically
    lines.forEach((ln,i)=>{
      const tspan = document.createElementNS('http://www.w3.org/2000/svg','tspan');
      tspan.setAttribute('x', pos.x);
      tspan.setAttribute('dy', i===0 ? startDy : 14);
      tspan.textContent = ln;
      txt.appendChild(tspan);
    });
    // clicking text shows full wish
    txt.addEventListener('click', ()=>{ alert('Wish: '+text); });
    wishGroup.appendChild(txt);
  }

  function renderWishList(){
    wishListEl.innerHTML = '';
    wishes.forEach((w,i)=>{
      const d = document.createElement('div');
      d.className = 'wish-item';
      d.innerHTML = `<strong>${i+1}.</strong> ${w}`;
      wishListEl.appendChild(d);
    });
  }

  addWishBtn.onclick = ()=>{
    const v = wishInput.value.trim(); if(!v) return alert('Tulis harapan dulu');
    const idx = wishes.length;
    wishes.push(v);
    placeWishText(v, idx); // draw on svg at computed position
    renderWishList();
    wishInput.value = '';
  };
  wishInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); addWishBtn.click(); } });

  // ————— SVG -> PNG helper (serialize & rasterize) —————
  function svgToDataUrl(svgEl, scale=2){
    return new Promise((resolve, reject)=>{
      const clone = svgEl.cloneNode(true);
      // inline computed styles that matter (fill colors) if needed — our SVG uses fills directly so OK
      const serializer = new XMLSerializer();
      let svgString = serializer.serializeToString(clone);
      // add xml header and proper namespace
      if(!svgString.match(/^<svg[^>]+xmlns=/)){
        svgString = svgString.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg" ');
      }
      svgString = '<?xml version="1.0" standalone="no"?>\n' + svgString;
      const svg64 = encodeURIComponent(svgString);
      const url = 'data:image/svg+xml;charset=utf-8,' + svg64;
      const img = new Image();
      img.onload = ()=>{
        // create canvas sized to svg viewBox
        const viewBox = svgEl.viewBox.baseVal;
        const w = viewBox && viewBox.width ? viewBox.width : svgEl.clientWidth;
        const h = viewBox && viewBox.height ? viewBox.height : svgEl.clientHeight;
        const canvas = document.createElement('canvas');
        canvas.width = (w || svgEl.clientWidth) * scale;
        canvas.height = (h || svgEl.clientHeight) * scale;
        const cctx = canvas.getContext('2d');
        // fill transparent or dark background? We'll keep transparent
        cctx.fillStyle = 'transparent';
        cctx.fillRect(0,0,canvas.width,canvas.height);
        cctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const data = canvas.toDataURL('image/png');
        resolve({data, width: canvas.width, height: canvas.height});
      };
      img.onerror = (e)=> reject(e);
      img.crossOrigin = 'anonymous';
      img.src = url;
    });
  }

  // DOWNLOAD Tree as PNG
  document.getElementById('downloadTreeBtn').addEventListener('click', async ()=>{
    try{
      const svg = document.getElementById('svgTree');
      const out = await svgToDataUrl(svg, 2);
      const a = document.createElement('a');
      a.href = out.data;
      a.download = `wish-tree-${Date.now()}.png`;
      a.click();
      // after download navigate to recap
      setTimeout(()=>{ treeCard.style.display='none'; recapCard.style.display='block'; }, 600);
    }catch(err){
      alert('Gagal generate tree: '+err);
      console.error(err);
    }
  });

  // DOWNLOAD Card (compose greeting + message + tree)
  document.getElementById('downloadCardBtn').addEventListener('click', async ()=>{
    try{
      const svg = document.getElementById('svgTree');
      const svgOut = await svgToDataUrl(svg, 2); // rasterized tree image
      // create canvas for card: landscape
      const W = 1200; const H = 630;
      const c = document.createElement('canvas'); c.width = W; c.height = H;
      const cctx = c.getContext('2d');
      // background (dark)
      cctx.fillStyle = '#070707'; cctx.fillRect(0,0,W,H);
      // left: greeting text
      const name = greetName.innerText || '';
      cctx.fillStyle = '#fff'; cctx.textAlign = 'left';
      cctx.font = '48px Georgia';
      cctx.fillText('Selamat Natal & Tahun Baru', 48, 120);
      cctx.font = '40px Georgia';
      cctx.fillStyle = '#ffd166';
      cctx.fillText(name, 48, 180);
      cctx.font = '20px Arial';
      cctx.fillStyle = '#cbd5e1';
      const message = 'Semoga tahun mendatang membawa kebahagiaan, kesehatan, dan kenangan manis.';
      // wrap message
      (function drawWrapped(text, x, y, maxW, lineH){
        const words = text.split(' ');
        let line = '', test='';
        for(let n=0;n<words.length;n++){
          const w = words[n];
          test = line + w + ' ';
          const tw = cctx.measureText(test).width;
          if(tw > maxW && n>0){ cctx.fillText(line, x, y); line = w + ' '; y += lineH; }
          else { line = test; }
        }
        if(line) cctx.fillText(line, x, y);
      })(message, 48, 230, W/2 - 80, 30);
      // draw tree image on right
      const treeImg = new Image();
      treeImg.src = svgOut.data;
      await new Promise((res,rej)=>{ treeImg.onload = res; treeImg.onerror = rej; });
      const tw = Math.min(420, W/2);
      const th = (treeImg.height / treeImg.width) * tw;
      cctx.drawImage(treeImg, W - tw - 48, (H - th)/2, tw, th);
      // wishes text block (small) on left-below
      cctx.fillStyle = '#fff';
      cctx.font = '18px Arial';
      let yy = 360;
      wishes.slice(0,6).forEach((w,i)=>{
        cctx.fillText(`${i+1}. ${w}`, 48, yy); yy += 28;
      });
      // trigger download
      const a = document.createElement('a'); a.href = c.toDataURL('image/png'); a.download = `card-${Date.now()}.png`; a.click();
    }catch(err){
      alert('Gagal generate card: '+err); console.error(err);
    }
  });

  // RECAP slider (simple). Use placeholder images.
  const recapInner = document.getElementById('recapInner');
  const recapImages = [];
  for(let i=1;i<=6;i++){ // 6 sample slides
    const url = `https://picsum.photos/seed/recap${i}/900/500`;
    recapImages.push(url);
  }
  recapImages.forEach(u=>{ const s=document.createElement('div'); s.style.minWidth='100%'; s.innerHTML = `<img src="${u}" style="width:100%;height:auto;border-radius:10px;display:block">`; recapInner.appendChild(s); });
  let slideIndex = 0; function showSlide(idx){ recapInner.style.transform = `translateX(-${idx*100}%)`; }
  document.getElementById('nextSlide').onclick = ()=>{ slideIndex = Math.min(slideIndex+1, recapImages.length-1); showSlide(slideIndex); };
  document.getElementById('prevSlide').onclick = ()=>{ slideIndex = Math.max(slideIndex-1, 0); showSlide(slideIndex); };

  // when done (user clicks Finish), show recap
  function goToRecap(){ treeCard.style.display='none'; recapCard.style.display='block'; }
  window.goToRecap = goToRecap;

  // initial: hide message & tree & recap until flow
  messageCard.style.display = 'none'; treeCard.style.display='none'; recapCard.style.display='none';

</script>
</body>
</html>
